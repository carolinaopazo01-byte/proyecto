{% extends "base/plantilla.html" %}

{% block title %}Subir Planificación{% endblock %}

{% block extra_css %}
<style>
  :root{
    --sp-sm:.6rem; --fs-sm:.9rem; --radius:12px;
    --border:#e5e7eb; --bg-head:#f8fafc;
  }

  /* Header consistente */
  .page-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:.75rem; }
  .page-head-left { display:flex; align-items:center; gap:10px; }

  .page { display:flex; flex-direction:column; gap:.75rem; }

  /* ===== Card de la sección (look CPC) ===== */
  .section{
    background:#fff; border:1px solid var(--border); border-radius:var(--radius);
    overflow:hidden; max-width:860px; margin-left:auto; margin-right:auto;
    box-shadow: 0 8px 18px rgba(0,0,0,.06);
  }
  .section__head{ padding:.65rem .9rem; background:var(--bg-head); border-bottom:1px solid #eef2f7; }
  .section__title{ font-size:.98rem; font-weight:800; margin:0; letter-spacing:.2px; }
  .section__body{ padding:1rem; }

  /* Grid más aireado */
  .plan-grid{ display:grid; grid-template-columns: 1fr; gap:.9rem; }
  @media (min-width: 992px){ .plan-grid{ grid-template-columns: 1fr 1fr; } }

  .stack{ display:flex; flex-direction:column; gap:.35rem; }
  .form-label{ font-weight:700; font-size:.9rem; margin:0; color:#056375; }

  .section .form-control,
  .section select,
  .section input[type="file"]{
    padding:.5rem .65rem !important;
    font-size: var(--fs-sm) !important;
    height:2.45rem;
    border-radius:10px;
    border:1px solid #cfd8e3;
    background:#fff;
    transition: box-shadow .12s ease, border-color .12s ease;
  }
  .section .form-control:focus, .section select:focus{
    border-color: var(--cpc-teal) !important;
    box-shadow: 0 0 0 .2rem var(--ring) !important;
    outline: none;
  }

  .hint{ font-size:.85rem; color:#64748b; }

  /* ===== Uploader bonito (drag & drop) ===== */
  .uploader{
    border:1px dashed #cfd8e3; border-radius:12px;
    padding:1rem; background:#fafafa;
    display:flex; flex-direction:column; align-items:center; gap:.6rem;
    text-align:center; transition:border-color .15s ease, background .15s ease;
    min-height: 160px; justify-content:center;
  }
  .uploader.is-drag{ border-color:#056375; background:#f0fbfd; }
  .uploader i{ font-size:28px; opacity:.9; }
  .uploader .lead{ font-weight:700; }
  .uploader .uploader-actions{ display:flex; gap:.5rem; flex-wrap:wrap; }
  .uploader .btn-sm{ padding:.38rem .7rem; border-radius:8px; }
  .uploader .file-name{ font-size:.9rem; color:#334155; word-break:break-word; }
  .visually-hidden{
    position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
    overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
  }

  /* ===== Acciones (consistente) ===== */
  .actions-wrap{
    position: sticky; bottom:16px; z-index:20;
    display:flex; justify-content:flex-end; gap:.5rem;
    padding:.65rem .9rem; max-width:860px; margin:1rem auto 0;
    border:1px solid #e5e7eb; border-radius:12px; background:rgba(255,255,255,.95);
    backdrop-filter:saturate(120%) blur(4px); box-shadow:0 6px 20px rgba(0,0,0,.08);
  }
  .btn-compact{ padding:.42rem .8rem; border-radius:10px; }
</style>
{% endblock %}

{% block content %}
  <!-- Cabecera sin botón Atrás local (lo maneja tu base si aplica) -->
  <div class="page-head mb-3">
    <div class="page-head-left">
      <h4 class="mb-0">Subir Planificación</h4>
    </div>
  </div>

  <form method="post" enctype="multipart/form-data" class="page" novalidate>
    {% csrf_token %}

    <!-- ===== Sección más bonita ===== -->
    <section class="section">
      <div class="section__head">
        <h6 class="section__title">Datos de la planificación</h6>
      </div>

      <div class="section__body">
        <div class="plan-grid">
          <!-- Columna 1 -->
          <div class="stack">
            <label class="form-label" for="{{ form.curso.id_for_label }}">Curso</label>
            {{ form.curso }}
            {% for e in form.curso.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}

            <label class="form-label mt-2" for="{{ form.semana.id_for_label }}">Semana</label>
            {{ form.semana }}
            <div class="hint">Se normaliza al <b>lunes</b> de esa semana.</div>
            {% for e in form.semana.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>

          <!-- Columna 2: Uploader mejorado -->
          <div class="stack">
            <label class="form-label" for="{{ form.archivo.id_for_label }}">Archivo</label>

            <!-- Input nativo accesible (oculto visualmente) -->
            <div class="visually-hidden">
              {{ form.archivo }}
            </div>

            <!-- Zona bonita -->
            <div class="uploader" id="uploaderBox"
                 role="button" tabindex="0"
                 aria-label="Subir archivo. Arrastra y suelta o haz clic para elegir.">
              <i class="fas fa-file-upload" aria-hidden="true"></i>
              <div class="lead">Arrastra tu archivo aquí</div>
              <div class="hint">o usa los botones</div>

              <div class="uploader-actions">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="btnChoose">
                  Elegir archivo
                </button>
                <button type="button" class="btn btn-light btn-sm" id="btnClear">
                  Quitar
                </button>
              </div>

              <div class="file-name mt-1" id="fileName">Ningún archivo seleccionado</div>
            </div>

            {% for e in form.archivo.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
        </div>
      </div>
    </section>

    <!-- Acciones -->
    <div class="actions-wrap">
      <a class="btn btn-light btn-compact" href="{% url 'core:planificaciones_list' %}">Cancelar</a>
      <button class="btn btn-primary btn-compact" type="submit">Guardar</button>
    </div>
  </form>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  // Detecta el input real del archivo (Django le asigna el id_for_label)
  var inputId = "{{ form.archivo.id_for_label }}";
  var input = document.getElementById(inputId) || document.querySelector('[name="{{ form.archivo.name }}"]');
  if(!input) return;

  var box = document.getElementById('uploaderBox');
  var btnChoose = document.getElementById('btnChoose');
  var btnClear = document.getElementById('btnClear');
  var fileName = document.getElementById('fileName');

  function updateName(){
    if (input.files && input.files.length){
      fileName.textContent = input.files.length === 1
        ? input.files[0].name
        : (input.files.length + ' archivos seleccionados');
    } else {
      fileName.textContent = 'Ningún archivo seleccionado';
    }
  }

  // Clicks
  btnChoose && btnChoose.addEventListener('click', function(){ input.click(); });
  btnClear && btnClear.addEventListener('click', function(){ input.value=''; updateName(); });

  // Permitir click en el panel (sin duplicar en botones)
  box && box.addEventListener('click', function(e){
    if (e.target === box) input.click();
  });
  box && box.addEventListener('keydown', function(e){
    if (e.key === 'Enter' || e.key === ' '){ e.preventDefault(); input.click(); }
  });

  // Drag & drop
  ['dragenter','dragover'].forEach(function(evt){
    box && box.addEventListener(evt, function(e){ e.preventDefault(); e.stopPropagation(); box.classList.add('is-drag'); });
  });
  ['dragleave','drop'].forEach(function(evt){
    box && box.addEventListener(evt, function(e){ e.preventDefault(); e.stopPropagation(); box.classList.remove('is-drag'); });
  });
  box && box.addEventListener('drop', function(e){
    if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length){
      input.files = e.dataTransfer.files;
      updateName();
    }
  });

  input.addEventListener('change', updateName);
  updateName();
})();
</script>
{% endblock %}
