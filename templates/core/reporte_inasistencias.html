{% extends "base.html" %}
{% block title %}Reporte semanal de inasistencias{% endblock %}
{% block header %}Reporte semanal de inasistencias{% endblock %}

{% block content %}
<form method="get" class="card p-3 mb-3" style="display:grid; grid-template-columns: 160px 170px 200px 200px 200px 140px 1fr; gap:10px; align-items:end;">
  <div>
    <label class="form-label">Semana (día)</label>
    <input type="date" name="semana" value="{{ semana }}">
  </div>
  <div>
    <label class="form-label">Programa</label>
    <select name="programa">
      <option value="">Todos</option>
      <option value="FORM" {% if programa == 'FORM' %}selected{% endif %}>Formativo</option>
      <option value="ALTO" {% if programa == 'ALTO' %}selected{% endif %}>Alto Rendimiento</option>
    </select>
  </div>
  <div>
    <label class="form-label">Sede</label>
    <select name="sede">
      <option value="">Todas</option>
      {% for s in sedes %}<option value="{{ s.id }}" {% if s.id|stringformat:"s" == request.GET.sede %}selected{% endif %}>{{ s.nombre }}</option>{% endfor %}
    </select>
  </div>
  <div>
    <label class="form-label">Disciplina</label>
    <select name="disciplina">
      <option value="">Todas</option>
      {% for d in disciplinas %}<option value="{{ d.id }}" {% if d.id|stringformat:"s" == request.GET.disciplina %}selected{% endif %}>{{ d.nombre }}</option>{% endfor %}
    </select>
  </div>
  <div>
    <label class="form-label">Profesor</label>
    <select name="prof">
      <option value="">Todos</option>
      {% for p in profes %}<option value="{{ p.id }}" {% if p.id|stringformat:"s" == request.GET.prof %}selected{% endif %}>{{ p.get_full_name }}</option>{% endfor %}
    </select>
  </div>
<div>
  <label class="form-label">Marcada por</label>
  <select name="marcador">
    <option value="" {% if request.GET.marcador == "" %}selected{% endif %}>Todos</option>
    <option value="prof" {% if request.GET.marcador == "prof" %}selected{% endif %}>Profesor</option>
    <option value="alum" {% if request.GET.marcador == "alum" %}selected{% endif %}>Alumno</option>
  </select>
</div>
  <div>
    <label class="form-label">Umbral alerta</label>
    <input type="number" name="umbral" min="1" value="{{ umbral }}">
  </div>
  <div style="display:flex; gap:8px;">
    <button class="btn" type="submit">Filtrar</button>
    <a class="btn" href="{% url 'core:reporte_inasistencias_export' %}?semana={{ semana }}&sede={{ request.GET.sede }}&disciplina={{ request.GET.disciplina }}&prof={{ request.GET.prof }}">Exportar CSV</a>
  </div>
</form>

<div class="grid mb-3" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:10px;">
  <div class="card p-3"><div class="text-muted">Inasistencias totales</div><div class="h4">{{ kpi_total_ausentes }}</div></div>
  <div class="card p-3"><div class="text-muted">Alumnos con ≥1 falta</div><div class="h4">{{ kpi_alumnos_con_falta }}</div></div>
  <div class="card p-3"><div class="text-muted">Alumnos con alerta (≥ {{ umbral }})</div><div class="h4">{{ kpi_alertas }}</div></div>
  <div class="card p-3"><div class="text-muted">% asistencia promedio</div><div class="h4">{{ kpi_pct }}%</div></div>
</div>

<p class="text-muted">Semana: {{ lunes|date:"d/m" }} – {{ domingo|date:"d/m/Y" }}</p>

<table class="table table-striped">
  <thead>
    <tr>
      <th>Curso/Actividad</th><th>Profesor</th><th>Sede</th><th>Día</th><th>Fecha</th>
      <th>Inscritos</th><th>Presentes</th><th>Ausentes</th><th>% Asistencia</th><th>Detalle</th>
    </tr>
  </thead>
  <tbody>
    {% for r in filas %}
      <tr>
        <td>{{ r.curso }}</td>
        <td>{{ r.profesor }}</td>
        <td>{{ r.sede }}</td>
        <td>{{ r.dia }}</td>
        <td>{{ r.fecha }}</td>
        <td>{{ r.inscritos }}</td>
        <td>{{ r.presentes }}</td>
        <td>{{ r.ausentes }}</td>
        <td>{{ r.pct }}%</td>
        <td><a class="btn" href="{% url 'core:reporte_inasistencias_detalle' r.clase.id %}">Ver detalle</a></td>
      </tr>
    {% empty %}
      <tr><td colspan="10">No hay registros para los filtros seleccionados.</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
