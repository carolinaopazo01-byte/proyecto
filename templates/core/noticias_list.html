{% extends "base/plantilla.html" %}
{% load static %}

{% block title %}Noticias{% endblock %}

{% block extra_css %}
<style>
  /* Tarjeta consistente y accesible */
  .news-card { border-radius: 12px; overflow: hidden; border:1px solid #e5e7eb; box-shadow:0 2px 6px rgba(0,0,0,.04); }
  .news-media { position: relative; width: 100%; aspect-ratio: 16/9; background: #f3f4f6; }
  .news-media img { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center; display:block; }

  .news-title { margin:0 0 .25rem; font-weight:800; line-height:1.2; }
  .news-bajada { color:#6b7280; margin:0 0 .35rem; }
  .news-bajada.truncate {
    display:-webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow:hidden;
  }

  .news-meta { font-size:.85rem; color:#6b7280; }

  /* Footer de acciones responsivo */
  .news-actions { display:flex; flex-wrap:wrap; gap:.5rem; }
  .news-actions form { display:inline-block; margin:0; }

  /* Filtros alineados */
  .filters .form-row > [class*="col-"] { padding-right:8px; }
  @media (max-width: 767.98px){
    .filters .form-row > [class*="col-"] { padding-right:0; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Noticias</h4>
    <a href="{% url 'core:noticia_create' %}" class="btn btn-primary">
      <i class="fas fa-plus"></i> Nueva noticia
    </a>
  </div>

  <!-- Filtros -->
  <form method="get" class="mb-3 filters">
    <div class="form-row align-items-end">
      <div class="col-md-5 mb-2">
        <label class="small mb-1">Buscar</label>
        <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Título o bajada">
      </div>
      <div class="col-md-3 mb-2">
        <label class="small mb-1">Estado</label>
        <select name="estado" class="form-control">
          <option value="">Todos</option>
          <option value="pub" {% if estado == "pub" %}selected{% endif %}>Publicadas</option>
          <option value="nopub" {% if estado == "nopub" %}selected{% endif %}>No publicadas</option>
        </select>
      </div>
      <div class="col-md-2 mb-2">
        <button class="btn btn-outline-secondary btn-block" type="submit">Filtrar</button>
      </div>
    </div>
  </form>

  <!-- Grid de tarjetas -->
  <div class="row">
    {% for n in page_obj.object_list %}
      <div class="col-md-6 col-lg-4 mb-3">
        <div class="card h-100 news-card">
          <!-- Imagen / placeholder -->
          <div class="news-media">
            {% if n.imagen %}
              <img src="{{ n.imagen.url }}" alt="{{ n.titulo }}">
            {% else %}
              <img src="{% static 'img/placeholder-news.jpg' %}" alt="Noticia sin imagen">
            {% endif %}
          </div>

          <div class="card-body">
            <h6 class="card-title news-title">{{ n.titulo }}</h6>

            {% if n.bajada %}
              <p class="news-bajada truncate">{{ n.bajada }}</p>
            {% endif %}

            <div class="news-meta">
              {% if n.publicada %}
                <span class="badge badge-success">Publicada</span>
              {% else %}
                <span class="badge badge-secondary">Borrador</span>
              {% endif %}
              {% if n.publicada_en %}
                <span class="text-muted ml-2">{{ n.publicada_en|date:"d/m/Y H:i" }}</span>
              {% endif %}
            </div>
          </div>

          <div class="card-footer bg-white">
            <div class="news-actions">
              <a class="btn btn-sm btn-outline-primary" href="{% url 'core:noticia_edit' n.id %}">
                <i class="fas fa-edit"></i> Editar
              </a>

              <form method="post" action="{% url 'core:noticia_toggle_publicar' n.id %}">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-warning" type="submit">
                  {% if n.publicada %}Despublicar{% else %}Publicar{% endif %}
                </button>
              </form>

              <form method="post" action="{% url 'core:noticia_delete' n.id %}" onsubmit="return confirm('¿Eliminar esta noticia?');">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-danger" type="submit">Eliminar</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="col-12">
        <div class="alert alert-info mb-0">No hay noticias.</div>
      </div>
    {% endfor %}
  </div>

  <!-- Paginación conservando filtros -->
  {% if page_obj.paginator.num_pages > 1 %}
    <nav class="mt-3">
      <ul class="pagination">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q|urlencode }}&estado={{ estado|urlencode }}">«</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">«</span></li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q|urlencode }}&estado={{ estado|urlencode }}">»</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">»</span></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
</div>
{% endblock %}
