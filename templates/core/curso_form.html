{% extends "base/plantilla.html" %}
{% load static %}

{% block title %}{% if is_edit %}Editar curso{% else %}Crear curso{% endif %}{% endblock %}

{% block extra_css %}
<style>
  :root{
    --sp-xs:.35rem; --sp-sm:.6rem; --sp-md:.9rem;
    --fs-xs:.82rem; --fs-sm:.9rem; --fs-md:1rem;
    --radius:10px;
    --border:#e5e7eb; --bg-head:#f8fafc;
  }

  .page { display:flex; flex-direction:column; gap: var(--sp-sm); }

  /* Cabecera */
  .page-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:.75rem; }
  .page-head-left { display:flex; align-items:center; gap:10px; }
  .page-title { margin:0; }

  /* Secciones (cards) */
  .section { background:#fff; border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; }
  .section__head { padding:.55rem .8rem; background:var(--bg-head); border-bottom:1px solid #eef2f7; }
  .section__title { font-size:.95rem; font-weight:700; margin:0; letter-spacing:.2px; }
  .section__body { padding:.8rem; }

  /* Grilla */
  .form-grid { display:grid; grid-template-columns: repeat(12,1fr); gap:.6rem; }
  .col-12{grid-column:span 12;} .col-6{grid-column:span 6;} .col-4{grid-column:span 4;}
  .col-3{grid-column:span 3;} .col-2{grid-column:span 2;}
  @media (max-width: 992px){ .col-6,.col-4,.col-3,.col-2{grid-column:span 12;} }

  /* Campos y foco consistente */
  .stack{ display:flex; flex-direction:column; gap:.25rem; }
  .form-label{ font-weight:600; font-size: var(--fs-xs); margin-bottom:0; }

  .section input[type="text"],
  .section input[type="number"],
  .section input[type="time"],
  .section input[type="date"],
  .section select,
  .section textarea,
  .section .form-control,
  .section .form-select{
    padding:.3rem .5rem !important;
    font-size: var(--fs-sm) !important;
    height:2.1rem;
    line-height:1.2;
    border-radius:8px;
    border:1px solid #cfd8e3;
    transition: box-shadow .12s, border-color .12s;
  }
  .section textarea{ min-height:110px; height:auto; }
  .section .form-control:focus, .section .form-select:focus, .section textarea:focus{
    border-color:#0d6efd; box-shadow:0 0 0 .2rem rgba(13,110,253,.15); outline:none;
  }

  /* Filas dinámicas (formset horarios) */
  .rows{ display:flex; flex-direction:column; gap:.5rem; }
  .row-box{ border:1px dashed var(--border); border-radius:8px; padding:.6rem; background:#fafafa; }
  .row-errors{ color:#dc3545; font-size:.8rem; margin:.25rem 0 0; }

  /* Acciones sticky centradas */
  .actions-wrap{
    position: sticky; bottom:16px; z-index:20;
    display:flex; justify-content:center; gap:.5rem;
    padding:.6rem .8rem; max-width:720px; margin:1rem auto 0;
    border:1px solid #e5e7eb; border-radius:12px;
    background:rgba(255,255,255,.95); backdrop-filter:saturate(120%) blur(4px);
    box-shadow:0 6px 20px rgba(0,0,0,.08);
  }
  .btn-compact{ padding:.35rem .7rem; border-radius:8px; }

  .field-errors{ color:#dc3545; font-size:.8rem; margin-top:.1rem; }
</style>
{% endblock %}

{% block content %}

  <!-- Cabecera -->
  <div class="page-head">
    <div class="page-head-left">
      <h4 class="page-title">{% if is_edit %}Editar curso{% else %}Crear curso{% endif %}</h4>
    </div>
    <a class="btn btn-light btn-sm" href="{% url 'core:cursos_list' %}">
      <i class="fas fa-list"></i> Listado
    </a>
  </div>

  <form method="post" novalidate class="page">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger mb-2" role="alert" aria-live="assertive">
        {% for e in form.non_field_errors %}<div>{{ e }}</div>{% endfor %}
      </div>
    {% endif %}

    <!-- 1) Identificación -->
    <section class="section">
      <div class="section__head"><h6 class="section__title">1. Identificación</h6></div>
      <div class="section__body">
        <div class="form-grid">
          <div class="col-6 stack">
            <label class="form-label" for="{{ form.nombre.id_for_label }}">Nombre del curso</label>
            {{ form.nombre }}{% if form.nombre.errors %}<div class="field-errors">{{ form.nombre.errors|join:", " }}</div>{% endif %}
          </div>
          <div class="col-3 stack">
            <label class="form-label" for="{{ form.programa.id_for_label }}">Programa</label>
            {{ form.programa }}{% if form.programa.errors %}<div class="field-errors">{{ form.programa.errors|join:", " }}</div>{% endif %}
          </div>
          <div class="col-3 stack">
            <label class="form-label" for="{{ form.disciplina.id_for_label }}">Disciplina</label>
            {{ form.disciplina }}{% if form.disciplina.errors %}<div class="field-errors">{{ form.disciplina.errors|join:", " }}</div>{% endif %}
          </div>
          <div class="col-6 stack">
            <label class="form-label" for="{{ form.categoria.id_for_label }}">Categoría (Sub-12, Adulto, Mixto)</label>
            {{ form.categoria }}{% if form.categoria.errors %}<div class="field-errors">{{ form.categoria.errors|join:", " }}</div>{% endif %}
          </div>
          <div class="col-6 stack">
            <label class="form-label" for="{{ form.sede.id_for_label }}">Sede / Recinto</label>
            {{ form.sede }}{% if form.sede.errors %}<div class="field-errors">{{ form.sede.errors|join:", " }}</div>{% endif %}
          </div>
        </div>
      </div>
    </section>

    <!-- 2) Calendario -->
    <section class="section">
      <div class="section__head"><h6 class="section__title">2. Calendario</h6></div>
      <div class="section__body">
        <div class="form-grid">
          <div class="col-6 stack">
            <label class="form-label" for="{{ form.fecha_inicio.id_for_label }}">Fecha inicio</label>
            {{ form.fecha_inicio }}{% if form.fecha_inicio.errors %}<div class="field-errors">{{ form.fecha_inicio.errors|join:", " }}</div>{% endif %}
          </div>
          <div class="col-6 stack">
            <label class="form-label" for="{{ form.fecha_termino.id_for_label }}">Fecha término</label>
            {{ form.fecha_termino }}{% if form.fecha_termino.errors %}<div class="field-errors">{{ form.fecha_termino.errors|join:", " }}</div>{% endif %}
          </div>
        </div>
      </div>
    </section>

    <!-- 3) Profesorado -->
    <section class="section">
      <div class="section__head"><h6 class="section__title">3. Profesorado</h6></div>
      <div class="section__body">
        <div class="form-grid">
          <div class="col-6 stack">
            <label class="form-label" for="{{ form.profesor.id_for_label }}">Profesor responsable</label>
            {{ form.profesor }}{% if form.profesor.errors %}<div class="field-errors">{{ form.profesor.errors|join:", " }}</div>{% endif %}
          </div>
          <div class="col-6 stack">
            <label class="form-label" for="{{ form.profesores_apoyo.id_for_label }}">Profesores de apoyo (opcional)</label>
            {{ form.profesores_apoyo }}{% if form.profesores_apoyo.errors %}<div class="field-errors">{{ form.profesores_apoyo.errors|join:", " }}</div>{% endif %}
          </div>
        </div>
      </div>
    </section>

    <!-- 4) Horarios -->
    <section class="section">
      <div class="section__head d-flex align-items-center justify-content-between">
        <h6 class="section__title mb-0">4. Horarios</h6>
        <button id="btn-add-horario" type="button" class="btn btn-outline-primary btn-compact">
          <i class="fas fa-plus"></i> Agregar horario
        </button>
      </div>
      <div class="section__body" data-formset-prefix="{{ formset.prefix }}">
        {{ formset.management_form }}

        {% if formset.non_form_errors %}
          <div class="alert alert-danger mb-2">
            {% for e in formset.non_form_errors %}<div>{{ e }}</div>{% endfor %}
          </div>
        {% endif %}

        <div class="rows" id="horarios-forms">
          {% for f in formset %}
            <div class="row-box">
              <div class="form-grid">
                <div class="col-4 stack">
                  <label class="form-label" for="{{ f.dia.id_for_label }}">Día</label>
                  {{ f.dia }}{% if f.dia.errors %}<div class="field-errors">{{ f.dia.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-3 stack">
                  <label class="form-label" for="{{ f.hora_inicio.id_for_label }}">Hora inicio</label>
                  {{ f.hora_inicio }}{% if f.hora_inicio.errors %}<div class="field-errors">{{ f.hora_inicio.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-3 stack">
                  <label class="form-label" for="{{ f.hora_fin.id_for_label }}">Hora fin</label>
                  {{ f.hora_fin }}{% if f.hora_fin.errors %}<div class="field-errors">{{ f.hora_fin.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-2 stack">
                  {% if formset.can_delete %}
                    <div class="form-check" style="margin-top:1.6rem">
                      {{ f.DELETE }}
                      <label class="form-check-label" for="{{ f.DELETE.id_for_label }}">Eliminar</label>
                    </div>
                  {% endif %}
                </div>
              </div>
              {% if f.non_field_errors %}
                <div class="row-errors">
                  {% for e in f.non_field_errors %}<div>{{ e }}</div>{% endfor %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <template id="empty-form-template">
          {% with ef=formset.empty_form %}
          <div class="row-box">
            <div class="form-grid">
              <div class="col-4 stack">
                <label class="form-label" for="{{ ef.dia.id_for_label }}">Día</label>{{ ef.dia }}
              </div>
              <div class="col-3 stack">
                <label class="form-label" for="{{ ef.hora_inicio.id_for_label }}">Hora inicio</label>{{ ef.hora_inicio }}
              </div>
              <div class="col-3 stack">
                <label class="form-label" for="{{ ef.hora_fin.id_for_label }}">Hora fin</label>{{ ef.hora_fin }}
              </div>
              <div class="col-2"></div>
            </div>
          </div>
          {% endwith %}
        </template>
      </div>
    </section>

    <!-- 5) Cupos e inscripciones -->
    <section class="section">
      <div class="section__head"><h6 class="section__title">5. Cupos e inscripciones</h6></div>
      <div class="section__body">
        <div class="form-grid">
          <div class="col-4 stack">
            <label class="form-label" for="{{ form.cupos.id_for_label }}">Cupos totales</label>
            {{ form.cupos }}{% if form.cupos.errors %}<div class="field-errors">{{ form.cupos.errors|join:", " }}</div>{% endif %}
          </div>
          <div class="col-4 stack">
            <label class="form-label" for="{{ form.cupos_espera.id_for_label }}">Cupos lista de espera (opcional)</label>
            {{ form.cupos_espera }}{% if form.cupos_espera.errors %}<div class="field-errors">{{ form.cupos_espera.errors|join:", " }}</div>{% endif %}
          </div>
          <div class="col-4 d-flex align-items-center">
            <div class="form-check">
              {{ form.permitir_inscripcion_rapida }}
              <label class="form-check-label" for="{{ form.permitir_inscripcion_rapida.id_for_label }}">Permitir inscripción rápida del profesor en 1ra clase</label>
            </div>
            {% if form.permitir_inscripcion_rapida.errors %}<div class="field-errors ms-2">{{ form.permitir_inscripcion_rapida.errors|join:", " }}</div>{% endif %}
          </div>
        </div>
      </div>
    </section>

    <!-- 6) Visibilidad / Estado -->
    <section class="section">
      <div class="section__head"><h6 class="section__title">6. Visibilidad / Estado</h6></div>
      <div class="section__body">
        <div class="form-grid">
          <div class="col-3 d-flex align-items-center">
            <div class="form-check">
              {{ form.publicado }}
              <label class="form-check-label" for="{{ form.publicado.id_for_label }}">Publicado</label>
            </div>
            {% if form.publicado.errors %}<div class="field-errors ms-2">{{ form.publicado.errors|join:", " }}</div>{% endif %}
          </div>
          <div class="col-4 stack">
            <label class="form-label" for="{{ form.estado.id_for_label }}">Estado</label>
            {{ form.estado }}{% if form.estado.errors %}<div class="field-errors">{{ form.estado.errors|join:", " }}</div>{% endif %}
          </div>
        </div>
      </div>
    </section>

    <!-- Acciones (sticky centradas) -->
    <div class="actions-wrap">
      <a class="btn btn-light btn-compact" href="{% url 'core:cursos_list' %}">Cancelar</a>
      <button class="btn btn-primary btn-compact" type="submit">
        {% if is_edit %}Guardar cambios{% else %}Guardar{% endif %}
      </button>
    </div>
  </form>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    function detectPrefix() {
      const wrap = document.querySelector('[data-formset-prefix]');
      if (wrap && wrap.getAttribute('data-formset-prefix')) {
        return wrap.getAttribute('data-formset-prefix');
      }
      const mgmt = document.querySelector('input[name$="-TOTAL_FORMS"]');
      return mgmt ? mgmt.name.replace(/-TOTAL_FORMS$/, '') : '';
    }

    function getTotalInput(prefix){
      if (prefix) {
        const exact = document.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`);
        if (exact) return exact;
      }
      return document.querySelector('input[name$="-TOTAL_FORMS"]');
    }

    const formPrefix = detectPrefix();
    const container  = document.getElementById("horarios-forms");
    const btnAdd     = document.getElementById("btn-add-horario");
    const tpl        = document.getElementById("empty-form-template");
    const totalInput = getTotalInput(formPrefix);

    if (!container || !btnAdd || !tpl || !totalInput) return;

    function materializeTemplate(index){
      const frag = document.createElement('div');
      frag.innerHTML = tpl.innerHTML.trim();
      const node = frag.firstElementChild;

      const walker = node.querySelectorAll('[name], [id], label[for]');
      walker.forEach(el => {
        if (el.name && el.name.includes('__prefix__')) el.name = el.name.replace(/__prefix__/g, String(index));
        if (el.id && el.id.includes('__prefix__')) el.id = el.id.replace(/__prefix__/g, String(index));
        if (el.tagName === 'LABEL' && el.htmlFor && el.htmlFor.includes('__prefix__')) el.htmlFor = el.htmlFor.replace(/__prefix__/g, String(index));
      });

      node.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'checkbox' || el.type === 'radio') {
          el.checked = false;
        } else if (el.tagName === 'SELECT') {
          el.selectedIndex = 0;
        } else {
          el.value = '';
        }
        if (el.type === 'time' && !el.hasAttribute('step')) {
          el.setAttribute('step', '60');
        }
      });

      return node;
    }

    btnAdd.addEventListener("click", function(){
      const index = parseInt(totalInput.value || "0", 10);
      const row = materializeTemplate(index);
      container.appendChild(row);
      totalInput.value = index + 1;
    });

    // Normalizar step de time existentes
    document.querySelectorAll('#horarios-forms input[type="time"]').forEach(i => {
      if (!i.hasAttribute('step')) i.setAttribute('step','60');
    });
  })();
</script>
{% endblock %}
