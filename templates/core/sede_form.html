{% extends "base.html" %}
{% block title %}{{ is_edit|yesno:"Editar sede,Nueva sede" }}{% endblock %}
{% block header %}{{ is_edit|yesno:"Editar sede,Nueva sede" }}{% endblock %}

{% block content %}
<link rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>

<style>
  #map { height: 320px; border:1px solid #ddd; border-radius:8px; }
  .row { display:grid; gap:8px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 720px){ .row { grid-template-columns: 1fr; } }
</style>

<form method="post" novalidate>
  {% csrf_token %}
  <div class="row">
    <div>
      <label>Nombre</label>
      {{ form.nombre }}
    </div>
    <div>
      <label>Comuna</label>
      {{ form.comuna }}
    </div>
    <div style="grid-column:1/-1">
      <label>Dirección (texto)</label>
      {{ form.direccion }}
      <small class="muted">Este texto es para referencia; la verificación usa las coordenadas.</small>
    </div>
  </div>

  {{ form.latitud }}  <!-- hidden -->
  {{ form.longitud }} <!-- hidden -->

  <div class="card p-2 mt-2">
    <b>Ubicación en mapa</b>
    <div class="row" style="margin-top:6px">
      <input id="search" class="input" placeholder="Buscar dirección (OpenStreetMap)">
      <div style="display:flex; gap:8px">
        <button type="button" class="btn" id="btnBuscar">🔎 Buscar</button>
        <button type="button" class="btn" id="btnMiUbicacion">📍 Usar mi ubicación</button>
      </div>
    </div>
    <div id="map" class="mt-2"></div>
    <div class="row mt-2">
      <div>
        <label>Radio de validación (m)</label>
        {{ form.radio_metros }}
      </div>
      <div>
        <label>Capacidad</label>
        {{ form.capacidad }}
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        {{ form.activa }} <label>Activo</label>
      </div>
    </div>
  </div>

  <div class="mt-2">
    <label>Descripción</label>
    {{ form.descripcion }}
  </div>

  <div class="mt-3">
    <button class="btn" type="submit">Guardar cambios</button>
    <a class="btn" href="{% url 'core:sedes_list' %}">Cancelar</a>
  </div>
</form>

<script>
(function(){
  const latInput = document.getElementById("id_latitud");
  const lngInput = document.getElementById("id_longitud");
  const radioInput = document.getElementById("id_radio_metros");

  // Centro por defecto: Coquimbo/La Serena
  const LAT_DEF = -29.95, LNG_DEF = -71.34, ZOOM_DEF = 13;

  const map = L.map('map').setView(
    [
      parseFloat(latInput.value || LAT_DEF),
      parseFloat(lngInput.value || LNG_DEF)
    ],
    latInput.value && lngInput.value ? 16 : ZOOM_DEF
  );

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let marker = null;
  let circle = null;

  function drawMarker(lat, lng){
    if (marker){ map.removeLayer(marker); }
    marker = L.marker([lat, lng], {draggable:true}).addTo(map);
    marker.on('dragend', e => {
      const p = e.target.getLatLng();
      setLatLng(p.lat, p.lng, false);
    });
  }

  function drawCircle(lat, lng){
    const r = parseInt(radioInput.value || 150, 10);
    if (circle){ map.removeLayer(circle); }
    circle = L.circle([lat, lng], {radius: r, color: '#2c7', fillOpacity: 0.08}).addTo(map);
  }

  function setLatLng(lat, lng, pan=true){
    latInput.value = lat.toFixed(6);
    lngInput.value = lng.toFixed(6);
    drawMarker(lat, lng);
    drawCircle(lat, lng);
    if (pan){ map.setView([lat, lng], 17); }
  }

  // Si ya hay coordenadas, pinta; si no, deja el mapa centrado por defecto
  if (latInput.value && lngInput.value){
    setLatLng(parseFloat(latInput.value), parseFloat(lngInput.value));
  }

  // Click en el mapa -> fija coordenadas
  map.on('click', (e)=> setLatLng(e.latlng.lat, e.latlng.lng));

  // Cambiar radio -> redibuja círculo
  radioInput.addEventListener('input', ()=>{
    if (latInput.value && lngInput.value){
      drawCircle(parseFloat(latInput.value), parseFloat(lngInput.value));
    }
  });

  // Buscar con Nominatim
  document.getElementById("btnBuscar").addEventListener("click", async ()=>{
    const q = document.getElementById("search").value.trim();
    if (!q) return;
    try{
      const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(q + " Chile");
      const r = await fetch(url, {headers: {'Accept-Language': 'es'}});
      const data = await r.json();
      if (data && data.length){
        const {lat, lon} = data[0];
        setLatLng(parseFloat(lat), parseFloat(lon));
      }else{
        alert("No se encontró esa dirección.");
      }
    }catch(err){
      alert("Error buscando la dirección.");
      console.error(err);
    }
  });

  // Usar mi ubicación
  document.getElementById("btnMiUbicacion").addEventListener("click", ()=>{
    if (!navigator.geolocation){ return alert("Tu navegador no soporta geolocalización."); }
   navigator.geolocation.getCurrentPosition(
  pos=>{
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const acc = pos.coords.accuracy;
    setLatLng(lat, lng);
    if (acc > 100) {
      alert(`⚠️ Ubicación detectada con baja precisión (${Math.round(acc)} m).
      Intenta usar un celular o conectar a una red Wi-Fi cercana para mejorar.`);
    }
  },
  err=>{
    alert("No se pudo obtener tu ubicación: " + err.message +
      "\nRevisa que hayas permitido el acceso a la ubicación en el navegador.");
  },
  {
    enableHighAccuracy: true,  // fuerza GPS cuando esté disponible
    timeout: 15000,
    maximumAge: 0
  }
);
  });
})();
</script>
{% endblock %}
