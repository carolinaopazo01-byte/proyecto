{% extends "base/plantilla.html" %}
{% block title %}Nueva ficha{% endblock %}
{% block header %}Nueva ficha{% endblock %}

{% block extra_css %}
<style>
  /* Contenedor tarjeta consistente y compacto */
  .ficha-card{max-width:900px;margin:auto;padding:14px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05)}

  /* Modo compacto global SOLO dentro del formulario de esta vista */
  .ficha-card .form-control,
  .ficha-card .form-select{
    padding:.28rem .5rem;            /* más pequeño */
    font-size:.85rem;
    line-height:1.2;
    border-radius:.4rem;
  }
  .ficha-card input[type="file"].form-control{padding:.2rem .5rem}
  .ficha-card textarea.form-control{min-height:80px}
  .ficha-card .form-label{margin-bottom:.25rem;font-weight:700;font-size:.85rem}
  .ficha-card .text-danger{font-size:.8rem}

  /* Autocompletar (finder) visual pequeño */
  #finder{padding:.32rem .55rem;font-size:.86rem}

  /* Fieldset de publicación */
  .pub-box{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
  .pub-box legend{font-size:.85rem;font-weight:800;padding:0 .35rem}

  /* Botones compactos */
  .ficha-card .btn{padding:.35rem .7rem;font-weight:800}
  .ficha-actions{display:flex;gap:.5rem;flex-wrap:wrap}

  /* Grid suave para campos anchos */
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:780px}
  .grid-1{display:grid;grid-template-columns:1fr;gap:10px;max-width:780px}

  @media (max-width:576px){
    .grid-2{grid-template-columns:1fr}
    .ficha-card{padding:12px}
  }
</style>
{% endblock %}

{% block content %}
<form method="post" enctype="multipart/form-data" class="ficha-card">
  {% csrf_token %}

  <!-- ================= Atleta con BUSCADOR ================= -->
  <div class="mb-2">
    <label class="form-label"><b>Atleta</b></label>

    <!-- Input de búsqueda con datalist (autocompletar) -->
    <input id="finder" class="form-control" list="paciente_suggest"
           placeholder="Escribe nombre, apellido o RUT (con puntos y guión)" autocomplete="off">
    <datalist id="paciente_suggest">
      {% for p in form.fields.paciente.queryset %}
        <option value="{{ p.nombres }} {{ p.apellidos }} — {{ p.rut }}"></option>
      {% endfor %}
    </datalist>

    <!-- El field real de Django queda oculto y sincronizado -->
    <div style="display:none">
      {{ form.paciente }}
    </div>

    <!-- Datos del alumno seleccionado -->
    <div class="text-muted" style="margin-top:6px;font-size:.86rem">
      <b>Previsión:</b> <span id="prevision-val">—</span>
      &nbsp;·&nbsp;
      <b>N° Emergencia:</b> <span id="emergencia-val">—</span>
    </div>

    <!-- Diccionarios JS construidos desde el queryset -->
    <script>
      // Helpers
      const norm = s => (s||'').toLowerCase()
        .normalize('NFD').replace(/\p{Diacritic}/gu, '');
      const normRut = s => {
        if(!s) return '';
        let r = s.toString().trim()
          .replace(/\./g,'').replace(/\s+/g,'').replace(/[–—]/g,'-').toUpperCase();
        if(!r.includes('-') && r.length >= 2) r = r.slice(0,-1) + '-' + r.slice(-1);
        return r;
      };

      // Mapa por id
      const PACS = {
        {% for p in form.fields.paciente.queryset %}
          "{{ p.pk }}": {
            id: "{{ p.pk }}",
            name: "{{ p.nombres|escapejs }} {{ p.apellidos|escapejs }}",
            rut: "{{ p.rut|upper }}",
            prevision: "{{ p.get_prevision_display|default:'—'|escapejs }}",
            emergencia: "{{ p.n_emergencia|default:'—'|escapejs }}"
          },
        {% endfor %}
      };

      // Índices de búsqueda (por texto y por RUT normalizado)
      const IDX = [];
      const IDX_RUT = {};
      for (const id in PACS) {
        const p = PACS[id];
        const label = `${p.name} — ${p.rut}`;
        IDX.push({ id, label, key: norm(label) });
        IDX_RUT[normRut(p.rut)] = id;
      }

      const $finder = document.getElementById('finder');
      const $sel = document.getElementById('id_paciente');
      const $prev = document.getElementById('prevision-val');
      const $emer = document.getElementById('emergencia-val');

      function setPaciente(id) {
        if (!$sel) return;
        $sel.value = id || '';
        if (id && PACS[id]) {
          $prev.textContent = PACS[id].prevision || '—';
          $emer.textContent = PACS[id].emergencia || '—';
          $finder.value = `${PACS[id].name} — ${PACS[id].rut}`;
        } else {
          $prev.textContent = '—';
          $emer.textContent = '—';
        }
      }

      function buscarYSeleccionar() {
        const q = $finder.value || '';
        const idRut = IDX_RUT[normRut(q)];
        if (idRut) { setPaciente(idRut); return; }

        const hit = IDX.find(x => x.label === q);
        if (hit) { setPaciente(hit.id); return; }

        const k = norm(q);
        const hit2 = IDX.find(x => x.key.includes(k));
        setPaciente(hit2 ? hit2.id : '');
      }

      $finder.addEventListener('change', buscarYSeleccionar);
      $finder.addEventListener('blur', buscarYSeleccionar);

      (function init(){
        const current = $sel && $sel.value;
        if (current) setPaciente(current); else setPaciente('');
      })();
    </script>
  </div>
  <!-- =============== /Atleta buscador =============== -->

  <div class="mb-2">
    <label class="form-label"><b>Motivo de atención</b></label>
    {{ form.motivo }}
    {% for e in form.motivo.errors %}<div class="text-danger">{{ e }}</div>{% endfor %}
  </div>

  <div class="mb-2">
    <label class="form-label"><b>Observaciones</b></label>
    {{ form.observaciones }}
  </div>

  <div class="mb-2">
    <label class="form-label"><b>Diagnóstico / Indicaciones</b></label>
    {{ form.diagnostico }}
  </div>

  <div class="grid-2 mb-2">
    <div>
      <label class="form-label"><b>Estado</b></label>
      {{ form.estado }}
    </div>
    <div>
      <label class="form-label"><b>Adjuntar archivo(s)</b></label>
      {{ form.adjuntos }}
    </div>
  </div>

  <fieldset class="pub-box mb-3">
    <legend class="float-none w-auto">Publicación (visibilidad)</legend>
    <label class="me-3"><input type="checkbox" name="publicar_profesor" {% if form.instance.publicar_profesor %}checked{% endif %}> Profesor/Entrenador</label>
    <label class="me-3"><input type="checkbox" name="publicar_coordinador" {% if form.instance.publicar_coordinador %}checked{% endif %}> Coordinador</label>
    <label><input type="checkbox" name="publicar_admin" {% if form.instance.publicar_admin %}checked{% endif %}> Administrador</label>
  </fieldset>

  <div class="ficha-actions">
    <button class="btn btn-primary" type="submit"><i class="fas fa-save me-1"></i> Guardar</button>
    <a class="btn btn-outline-secondary" href="{% url 'pmul:fichas_list' %}">Cancelar</a>
  </div>
</form>
{% endblock %}
