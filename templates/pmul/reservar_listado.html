{% extends "base.html" %}
{% block header %}Reservar hora{% endblock %}
{% block content %}

{# --- BLOQUE DE PRÓXIMA CITA --- #}
{% if proxima_cita %}
  <div style="background:#eef8ff;border:1px solid #bfe0ff;
              padding:12px;border-radius:8px;margin-bottom:16px;">
    <strong>Tu próxima cita:</strong>
    {{ proxima_cita.inicio|date:"D d/m H:i" }} – {{ proxima_cita.fin|date:"H:i" }}
    con {{ proxima_cita.profesional.get_full_name|default:proxima_cita.profesional.username }}
  </div>
{% endif %}

<form method="get" class="mb-3" style="display:flex;gap:10px;align-items:end;">
  <div>
    <label>Semana:</label>
    <input type="date" name="semana" value="{{ semana }}">
  </div>
  <div>
    <label>Especialidad:</label>
    <select name="subrol">
      <option value="">Todos</option>
      <option value="KIN"  {% if request.GET.subrol == "KIN" %}selected{% endif %}>Kinesiología</option>
      <option value="PSI"  {% if request.GET.subrol == "PSI" %}selected{% endif %}>Psicología</option>
      <option value="NUT"  {% if request.GET.subrol == "NUT" %}selected{% endif %}>Nutrición</option>
      <option value="TENS" {% if request.GET.subrol == "TENS" %}selected{% endif %}>TENS</option>
    </select>
  </div>
  <button class="btn">Filtrar</button>
  <a class="btn" href="?semana={{ semana_anterior }}&subrol={{ request.GET.subrol }}">« Semana anterior</a>
  <a class="btn" href="?semana={{ semana_siguiente }}&subrol={{ request.GET.subrol }}">Semana siguiente »</a>
</form>

<p class="text-muted">
  Mostrando del <strong>{{ desde|date:"d/m" }}</strong> al <strong>{{ hasta|date:"d/m" }}</strong>.
</p>

<table class="table">
  <thead>
    <tr>
      <th>Profesional</th>
      <th>Inicio</th>
      <th>Fin</th>
      <th>Piso</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for s in slots %}
      <tr>
        <td>
          {{ s.profesional.first_name }} {{ s.profesional.last_name }}
          ({{ s.profesional.perfil_pmul.get_especialidad_display }})
        </td>
        <td>{{ s.inicio|date:"d/m H:i" }}</td>
        <td>{{ s.fin|date:"H:i" }}</td>
        <td>{{ s.piso }}</td>
        <td>
          <a class="btn btn-sm btn-primary"
             href="{% url 'pmul:reservar_confirmar' s.id %}">
             Reservar
          </a>
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="5" class="text-muted">No hay cupos disponibles.</td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
