{% extends "base/plantilla.html" %}

{% block title %}Equipo (usuarios){% endblock %}

{% block extra_css %}
<style>
  /* Cabecera */
  .page-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:.75rem; }
  .page-head-left{ display:flex; align-items:center; gap:10px; }

  /* Filtros */
  .filters-card .card-body{
    padding-top:.75rem; padding-bottom:.75rem;
    padding-left: var(--cpc-gutter-x, 16px); padding-right: var(--cpc-gutter-x, 16px);
  }
  .filters .form-control, .filters select, .filters input[type="text"]{
    height:2.1rem; font-size:.95rem;
    border-radius:10px; border:1px solid #cfd8e3;
  }
  .filters .form-control:focus, .filters select:focus{
    border-color:#0d6efd; box-shadow:0 0 0 .2rem rgba(13,110,253,.15); outline:none;
  }
  .filters-actions{ display:flex; gap:8px; justify-content:flex-end; }
  @media (max-width:576px){ .filters-actions{ justify-content:flex-start; } }

  /* Tabla */
  .table thead th{ white-space:nowrap; background:#f8fafc; }
  .table td, .table th{ vertical-align:middle; }
  .table-wrap{ border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; }

  /* Acciones columna */
  .col-actions-th{ width:300px; text-align:right; }
  .col-actions-td{ text-align:right; }
  .actions-inline{
    display:inline-flex; justify-content:flex-end; align-items:center;
    gap:.4rem; flex-wrap:wrap;
  }
  .actions-inline form{ margin:0; }
  .btn-action{ padding:.35rem .6rem; line-height:1.1; border-radius:8px; font-size:.875rem; }
  .btn-action[disabled]{ opacity:.6; pointer-events:none; }

  /* Badges estado (compatibles con Bootstrap 4/5) */
  .badge-success{ background-color:#198754; } .badge-secondary{ background-color:#6c757d; }
</style>
{% endblock %}

{% block content %}

  <!-- Cabecera -->
  <div class="page-head">
    <div class="page-head-left">
      <h4 class="mb-0">Equipo (usuarios)</h4>
    </div>
    <div class="d-flex" style="gap:8px;">
      <a class="btn btn-primary" href="{% url 'usuarios:usuario_create' %}">
        <i class="fas fa-user-plus"></i> Nuevo
      </a>
      <a class="btn btn-outline-secondary"
         href="?q={{ q }}&rol={{ rol }}&estado={{ estado }}&export=1">
        <i class="fas fa-file-excel"></i> Exportar Excel
      </a>
    </div>
  </div>

  <!-- Filtros -->
  <form method="get" class="card filters-card mb-3 filters">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-lg-5">
          <label class="form-label mb-1">Buscar</label>
          <input class="form-control" type="text" name="q" value="{{ q }}" placeholder="RUT / Nombre / Usuario / Email">
        </div>

        <div class="col-lg-3">
          <label class="form-label mb-1">Rol</label>
          <select class="form-control" name="rol">
            <option value="">Todos</option>
            {% for value,label in roles %}
              <option value="{{ value }}" {% if value == rol %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-lg-2">
          <label class="form-label mb-1">Estado</label>
          <select class="form-control" name="estado">
            <option value="">Todos</option>
            <option value="act" {% if estado == "act" %}selected{% endif %}>Activo</option>
            <option value="inact" {% if estado == "inact" %}selected{% endif %}>Inactivo</option>
          </select>
        </div>

        <div class="col-12">
          <div class="filters-actions">
            <button class="btn btn-primary" type="submit"><i class="fas fa-search"></i> Buscar</button>
            <a class="btn btn-outline-secondary" href="?q=&rol=&estado=">Limpiar</a>
          </div>
        </div>
      </div>
    </div>
  </form>

  {% if items %}
    <div class="table-wrap">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead>
            <tr>
              <th>RUT</th>
              <th>Nombre</th>
              <th>Usuario</th>
              <th>Rol</th>
              <th>Email</th>
              <th>Teléfono</th>
              <th>Estado</th>
              <th class="col-actions-th">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for u in items %}
              <tr>
                <td>{{ u.rut }}</td>
                <td>{{ u.first_name }} {{ u.last_name }}</td>
                <td>{{ u.username }}</td>
                <td>{{ u.get_tipo_usuario_display }}</td>
                <td>{{ u.email }}</td>
                <td>{{ u.telefono }}</td>
                <td>
                  {% if u.is_active %}
                    <span class="badge badge-success">Activo</span>
                  {% else %}
                    <span class="badge badge-secondary">Inactivo</span>
                  {% endif %}
                </td>
                <td class="col-actions-td">
                  <span class="actions-inline">
                    <a class="btn btn-sm btn-outline-info btn-action" href="{% url 'usuarios:usuario_detail' u.id %}">
                      <i class="fas fa-eye"></i> Ver
                    </a>

                    <a class="btn btn-sm btn-outline-primary btn-action" href="{% url 'usuarios:usuario_edit' u.id %}">
                      <i class="fas fa-pen"></i> Editar
                    </a>

                    <form method="post" action="{% url 'usuarios:usuario_toggle_active' u.id %}" onsubmit="this.querySelector('button').disabled=true;">
                      {% csrf_token %}
                      <button class="btn btn-sm btn-outline-secondary btn-action" type="submit">
                        {% if u.is_active %}<i class="fas fa-user-slash"></i> Desactivar{% else %}<i class="fas fa-user-check"></i> Activar{% endif %}
                      </button>
                    </form>

                    <form method="post" action="{% url 'usuarios:usuario_delete' u.id %}"
                          onsubmit="if(!confirm('¿Eliminar este usuario? Esta acción no se puede deshacer.')) return false; this.querySelector('button').disabled=true;">
                      {% csrf_token %}
                      <button class="btn btn-sm btn-outline-danger btn-action" type="submit">
                        <i class="fas fa-trash-alt"></i> Eliminar
                      </button>
                    </form>
                  </span>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <div class="alert alert-info mb-0">No hay usuarios para los filtros aplicados.</div>
  {% endif %}

{% endblock %}
