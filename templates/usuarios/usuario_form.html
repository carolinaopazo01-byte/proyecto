{% extends "base/plantilla.html" %}
{% load static %}

{% block title %}{% if is_edit %}Editar usuario{% else %}Nuevo usuario{% endif %}{% endblock %}

{% block extra_css %}
<style>
  :root{
    --fs-xs:.85rem;
    --border:#e5e7eb; --bg-head:#f8fafc;
    --radius:10px;
  }

  .hidden{ display:none; }
  .field-errors{ color:#dc3545; font-size:.85rem; margin-top:.15rem; }

  /* Cabecera simple (consistente) */
  .page-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:.75rem; }
  .page-title{ margin:0; }

  /* Secciones tipo card (consistente con otras vistas) */
  .section{ background:#fff; border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; }
  .section + .section{ margin-top:.6rem; }
  .section__head{ padding:.55rem .8rem; background:var(--bg-head); border-bottom:1px solid #eef2f7; }
  .section__title{ font-weight:700; font-size:.95rem; margin:0; }
  .section__body{ padding:.8rem; }

  /* Grilla de formulario */
  .form-grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:.6rem; }
  .col-12{grid-column:span 12;} .col-8{grid-column:span 8;} .col-6{grid-column:span 6;}
  .col-4{grid-column:span 4;} .col-3{grid-column:span 3;}
  @media (max-width: 992px){ .col-8,.col-6,.col-4,.col-3{grid-column:span 12;} }

  .stack{ display:flex; flex-direction:column; gap:.25rem; }
  .form-label{ font-weight:600; font-size:var(--fs-xs); margin-bottom:0; }

  /* Inputs con foco consistente */
  .section .form-control, .section .form-select, .section input, .section select, .section textarea{
    border:1px solid #cfd8e3; border-radius:8px; padding:.45rem .6rem;
    transition: box-shadow .12s, border-color .12s;
  }
  .section .form-control:focus, .section .form-select:focus, .section input:focus, .section select:focus, .section textarea:focus{
    border-color:#0d6efd; box-shadow:0 0 0 .2rem rgba(13,110,253,.15); outline:none;
  }

  /* Nota de ayuda */
  .help-note{ color:#6b7280; font-size:.9rem; margin:.25rem 0 0; }

  /* Barra de acciones: sticky y centrada */
  .actions-wrap{
    position:sticky; bottom:16px; z-index:20;
    display:flex; justify-content:center; gap:.5rem;
    padding:.6rem .8rem; max-width:720px; margin:1rem auto 0;
    border:1px solid #e5e7eb; border-radius:12px;
    background:rgba(255,255,255,.95); backdrop-filter:saturate(120%) blur(4px);
    box-shadow:0 6px 20px rgba(0,0,0,.08);
  }
  .btn-compact{ padding:.35rem .7rem; border-radius:8px; }
</style>
{% endblock %}

{% block content %}
<div class="page-head">
  <h4 class="page-title">{% if is_edit %}Editar usuario{% else %}Nuevo usuario{% endif %}</h4>
</div>

<form method="post" novalidate class="page">
  {% csrf_token %}

  {# —— RESUMEN DE ERRORES —— #}
  {% if form.errors or form.non_field_errors %}
    <div class="alert alert-danger mb-2" role="alert" aria-live="assertive">
      <div><strong>Hay errores en el formulario.</strong> Revísalos por favor.</div>
      {% if form.non_field_errors %}
        <div class="mt-1">
          {% for e in form.non_field_errors %}<div>{{ e }}</div>{% endfor %}
        </div>
      {% endif %}
    </div>
  {% endif %}

  <!-- 1) Datos personales -->
  <section class="section">
    <div class="section__head"><h6 class="section__title">1. Datos personales</h6></div>
    <div class="section__body">
      <div class="form-grid">
        <div class="col-4 stack">
          <label class="form-label" for="{{ form.rut.id_for_label }}">RUT</label>
          {{ form.rut }}
          {% for e in form.rut.errors %}<div class="field-errors">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-4 stack">
          <label class="form-label" for="{{ form.first_name.id_for_label }}">Nombres</label>
          {{ form.first_name }}
          {% for e in form.first_name.errors %}<div class="field-errors">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-4 stack">
          <label class="form-label" for="{{ form.last_name.id_for_label }}">Apellidos</label>
          {{ form.last_name }}
          {% for e in form.last_name.errors %}<div class="field-errors">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-8 stack">
          <label class="form-label" for="{{ form.email.id_for_label }}">Email</label>
          {{ form.email }}
          {% for e in form.email.errors %}<div class="field-errors">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-4 stack">
          <label class="form-label" for="{{ form.telefono.id_for_label }}">Teléfono</label>
          {{ form.telefono }}
          {% for e in form.telefono.errors %}<div class="field-errors">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-4 stack">
          <label class="form-label" for="{{ form.fecha_nacimiento.id_for_label }}">Fecha de nacimiento</label>
          {{ form.fecha_nacimiento }}
          {% for e in form.fecha_nacimiento.errors %}<div class="field-errors">{{ e }}</div>{% endfor %}
        </div>
      </div>
    </div>
  </section>

  <!-- 2) Rol y estado -->
  <section class="section">
    <div class="section__head"><h6 class="section__title">2. Rol y estado</h6></div>
    <div class="section__body">
      <div class="form-grid">
        <div class="col-6 stack">
          <label class="form-label" for="{{ form.tipo_usuario.id_for_label }}">Rol</label>
          {{ form.tipo_usuario }}
          {% for e in form.tipo_usuario.errors %}<div class="field-errors">{{ e }}</div>{% endfor %}
        </div>

        <!-- Sub-rol (solo visible si PMUL) -->
        <div id="group-subrol" class="col-6 stack hidden">
          <label class="form-label" for="{{ form.equipo_rol.id_for_label }}">Sub-rol (Equipo Multidisciplinario)</label>
          {{ form.equipo_rol }}
          {% for e in form.equipo_rol.errors %}<div class="field-errors">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-3 d-flex align-items-center" style="gap:.4rem;">
          {{ form.is_active }}
          <label class="form-check-label mb-0" for="{{ form.is_active.id_for_label }}">Activo</label>
          {% for e in form.is_active.errors %}<div class="field-errors">{{ e }}</div>{% endfor %}
        </div>
      </div>

      <p class="help-note">
        Permisos automáticos por rol: Administrador = staff + superusuario; Coordinador = staff; otros = sin staff.
        {% if not is_edit %}
          <br>La contraseña inicial se generará como <strong>DDMMAAAA</strong> con la fecha de nacimiento.
        {% endif %}
      </p>
    </div>
  </section>

  <!-- Acciones (sticky centradas) -->
  <div class="actions-wrap">
    <a class="btn btn-light btn-compact" href="{% url 'usuarios:usuarios_list' %}">Cancelar</a>
    <button class="btn btn-primary btn-compact" type="submit">Guardar</button>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  var selectRol = document.getElementById("id_tipo_usuario");
  var groupSubrol = document.getElementById("group-subrol");

  function toggleSubrol(){
    if(!selectRol || !groupSubrol) return;
    var esPMUL = (selectRol.value === "PMUL");
    groupSubrol.classList.toggle("hidden", !esPMUL);
  }

  toggleSubrol();
  if(selectRol){ selectRol.addEventListener("change", toggleSubrol); }
})();
</script>
{% endblock %}
