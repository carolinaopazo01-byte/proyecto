{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" href="{% static 'img/logo/mi_logo.png' %}">
  <title>{% block title %}CPC - Dashboard{% endblock %}</title>

  <!-- CSS global -->
  <link href="{% static 'vendor/fontawesome-free/css/all.min.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet">
  <link href="{% static 'css/cpc-uniform.css' %}" rel="stylesheet">

  <style>
    /* ================= PALETA UNIFICADA ================= */
    :root{
      --topbar-h:56px; --brand-h:56px;
      --sb-w-desktop:220px; --sb-w-mobile:260px;
      --rhythm:18px;

      /* Neutros y texto */
      --bg:#f5f7fb;            /* fondo app */
      --surface:#ffffff;       /* tarjetas, topbar, sidebar */
      --line:#e5e7eb;          /* líneas sutiles cuando se necesiten */
      --text:#1f2937;          /* texto principal */
      --text-weak:#6b7280;     /* texto secundario */

      /* Primario CPC (teal profesional) en escala */
      --primary-50:#e8f6f7;
      --primary-100:#d6eff1;
      --primary-200:#aee0e5;
      --primary-300:#7fcfd6;
      --primary-400:#3fb6c0;
      --primary-500:#159aa7;
      --primary-600:#0e7c86;   /* base UI */
      --primary-700:#0a5a64;   /* barras/acentos fuertes */
      --primary-800:#083f49;

      /* Borde tarjetas sutil alineado a primario */
      --card-br: #cfe7ea;     /* borde suave, toma el tono light del primario */
      --card-shadow:0 2px 6px rgba(0,0,0,.04);

      /* Sombras idénticas (doble capa) para topbar y sidebar */
      --elev-shadow-1: 0 2px 10px rgba(17, 24, 39, .10);
      --elev-shadow-2: 0 1px  2px rgba(17, 24, 39, .06);
      --elev-shadow: var(--elev-shadow-1), var(--elev-shadow-2);
    }

    html,body{height:100%;}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:"Manrope",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    .app{min-height:100dvh; display:flex;}

    /* ===== Sidebar ===== */
    .sidebar{
      width:var(--sb-w-desktop); flex:0 0 var(--sb-w-desktop);
      background: var(--surface);
      border-right:none;
      display:flex; flex-direction:column; z-index:900;
      transition: box-shadow .22s ease, border-color .22s ease, background .22s ease;
      box-shadow: none;
    }
    .sidebar.sb-elevated{ box-shadow: var(--elev-shadow); }

    .sb-brand{
      height:var(--brand-h);
      padding:0 12px;
      display:flex; align-items:center; justify-content:space-between;
      background: var(--surface);
      border-bottom:none;
      will-change: transform;
    }
    @media (min-width: 992px){
      .sb-brand.sb-top-hidden{ transform: translateY(-100%); transition: none; }
    }

    .sb-scroll{flex:1 1 auto; padding:var(--rhythm) 12px; overflow:hidden; background: var(--surface);}

    .sb-profile{
      display:flex; align-items:center; gap:.6rem;
      background:var(--surface); border:1px solid var(--card-br); border-radius:12px;
      padding:.55rem .7rem; margin-bottom:var(--rhythm);
      box-shadow:var(--card-shadow);
    }
    .sb-profile-avatar{
      width:34px; height:34px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center;
      background:var(--primary-50); color:var(--primary-600); flex:0 0 34px;
    }
    .sb-profile-info{ min-width:0; }
    .sb-profile-name{ font-weight:800; font-size:.9rem; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.15; }
    .sb-profile-mail{ font-size:.78rem; color:var(--text-weak); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.2; }

    .sb-section{
      background:var(--surface); border:1px solid var(--card-br); border-radius:12px;
      box-shadow:var(--card-shadow); overflow:hidden; margin-bottom: var(--rhythm);
    }
    .sb-head{
      display:flex; gap:6px; align-items:center; padding:10px 12px;
      background:var(--primary-50);
      border-bottom:none;
      font-weight:900; font-size:12px; color:var(--primary-700);
    }
    .sb-head i{ width:14px; text-align:center; font-size:12px; color:var(--primary-700); }
    .sb-body{ padding:8px; display:flex; flex-direction:column; gap:8px; }

    .sb-link{
      display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px;
      font-weight:700; color:#3b4656; border:1px solid transparent; text-decoration:none;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; background:transparent;
    }
    .sb-link i{ width:14px; min-width:14px; text-align:center; color:#7b8797; font-size:13px; }
    .sb-link:hover{
      background:var(--primary-50); color:var(--primary-700); border-color: var(--primary-200);
    }
    .sb-link:hover i{ color:var(--primary-700); }

    .sb-foot{
      margin-top:auto; border-top:none; background:var(--surface); padding: var(--rhythm) 10px;
    }
    .sb-logout{
      display:flex; gap:8px; align-items:center; justify-content:center; padding:9px 10px; border-radius:10px;
      font-weight:800; color:#b91c1c; border:1px solid #f5caca; background:var(--surface); text-decoration:none;
    }
    .sb-logout:hover{ background:#fff4f4; border-color:#f0b5b5; }
    .sb-meta{ color:#94a3b8; font-size:.72rem; text-align:center; margin-top:8px; }

    /* ===== Content / Topbar ===== */
    .content{ flex:1 1 auto; display:flex; flex-direction:column; min-width:0; }

    .topbar{
      height:var(--topbar-h); display:flex; align-items:center;
      border-bottom:none; box-shadow: var(--elev-shadow);
      background:var(--surface); padding:0 12px; position:relative; z-index:1000;
      background-clip: padding-box;
    }
    .topbar-logo{ height:28px; width:auto; display:block; object-fit:contain; }

    .container-page{ flex:1 1 auto; padding:var(--rhythm) 16px; }
    .container-page > *:first-child{ margin-top:0; }

    /* Footer sólido y legible (sin degradado) */
    footer.footer{
      background: var(--primary-700);
      color:#ffffff;
    }
    footer.footer b{ color:#ffffff; }

    /* === Botón hamburguesa === */
    #menuBtn{
      position:fixed; top:8px; left:8px; display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border:none; background:transparent; color: var(--primary-700);
      padding:0; margin:0; line-height:1; border-radius:8px; box-shadow:none; z-index:2147483647; cursor:pointer;
      transition:opacity .18s ease, transform .18s ease, visibility .18s ease;
    }
    #menuBtn .icon-bars{ width:22px; height:22px; display:inline-block; }
    #menuBtn svg path{ stroke:currentColor; stroke-width:2; fill:none; stroke-linecap:round; }
    #menuBtn:focus{ outline:none; }
    #menuBtn.is-hidden{ opacity:0; visibility:hidden; pointer-events:none; transform:translateY(-8px); }
    @media (min-width: 992px){ #menuBtn{ display:none; } }

    /* ===== Responsive ===== */
    @media (max-width: 991.98px){
      .sidebar{
        position:fixed; left:0; top:0; bottom:0; width:var(--sb-w-mobile);
        transform:translateX(-100%); transition:none; background:var(--surface); z-index:1000;
      }
      body.nav-open .sidebar{ transform:translateX(0); }
      .sb-brand{ padding-left:56px; }
      .sb-scroll{ padding-top: calc(var(--rhythm) + 12px); }
      .sb-profile{ margin-top: 4px; }
    }
    @media (min-width: 992px){
      .sidebar{ position:relative; transform:none; transition:none; }
    }

    .sidebar{ font-size:12.5px; }
    .sb-head{ font-size:14px; font-weight:900; letter-spacing:.2px; padding:8px 10px; }
    .sb-link{ font-size:12.5px; padding:7px 10px; }
    .sb-link i{ font-size:12px; width:14px; min-width:14px; }
    .sb-meta{ font-size:11.5px; }
    .sb-logout{ font-size:12.5px; }
    @media (max-width: 991.98px){
      .sb-head{ padding:10px 12px; font-size:14px; }
      .sb-link{ padding:10px 12px; font-size:12.5px; }
    }

    /* Sticky sin efectos para topbar */
    .topbar{
      position: sticky;
      top: max(env(safe-area-inset-top, 0px), 0px);
      will-change: transform; transform: translateZ(0); contain: paint; backface-visibility: hidden;
      transition: none;
    }
    #menuBtn{ top: calc(8px + env(safe-area-inset-top, 0px)); }
    html{ overflow-x:hidden; }
    body.nav-open{ overflow: hidden; touch-action: none; }
    .scroll-locked{ position: fixed; inset: 0; width:100%; overflow:hidden; }
    @supports (-webkit-touch-callout: none){ .topbar{ position: sticky; } }

    /* Desktop: ocultar topbar + franja superior del sidebar juntos (sin animación) */
    @media (min-width: 992px){
      .topbar{ top: 0; }
      .topbar.topbar-hidden{ transform: translateY(-100%); }
    }

    /* ========= OVERRIDES PARA QUITAR CUALQUIER LÍNEA EN TOPBAR ========= */
    body nav.topbar,
    body .content > nav.topbar,
    body .content nav.topbar,
    nav.topbar{
      border-bottom: 0 !important;
      background-image: none !important;
      box-shadow: var(--elev-shadow) !important;
      outline: 0 !important;
    }
    nav.topbar::before,
    nav.topbar::after{
      content: none !important;
      border: 0 !important;
      box-shadow: none !important;
      background: none !important;
    }
    .topbar + .container-page{
      border-top: 0 !important;
      box-shadow: none !important;
      background-image: none !important;
    }

    /* ===== Accesibilidad/estados comunes ===== */
    a{ color:var(--primary-600); }
    a:hover{ color:var(--primary-700); }
    .btn-primary{
      background:var(--primary-600); border-color:var(--primary-600);
    }
    .btn-primary:hover, .btn-primary:focus{
      background:var(--primary-700); border-color:var(--primary-700);
    }
    .form-control:focus{
      border-color:var(--primary-300); box-shadow:0 0 0 3px rgba(21,154,167,.18);
    }

    /* === Unificar color de barras superior e inferior === */
:root{
  /* usa el mismo color del footer */
  --bar-color: var(--primary-700);
  --bar-text: #ffffff;
}

/* Topbar con el mismo color del footer */
.topbar{
  background: var(--bar-color) !important;
  color: var(--bar-text);
  box-shadow: var(--elev-shadow);
}
.topbar, .topbar *{ color: var(--bar-text); }

/* Franja superior del sidebar con el mismo color */
.sb-brand{
  background: var(--bar-color) !important;
  color: var(--bar-text);
  border-bottom: none;
}
.sb-brand, .sb-brand *{ color: var(--bar-text); }

/* Footer ya usaba var(--primary-700); lo atamos a la misma variable */
footer.footer{
  background: var(--bar-color) !important;
  color: var(--bar-text) !important;
}
footer.footer b{ color: var(--bar-text) !important; }

/* Accesibilidad del botón hamburguesa en móvil (contraste sobre la topbar) */
@media (max-width: 991.98px){
  #menuBtn{ color: var(--bar-text) !important; }
}

  </style>

  {% block extra_css %}{% endblock %}
</head>
<body>

<button id="menuBtn" aria-label="Abrir menú" aria-expanded="false">
  <svg class="icon-bars" viewBox="0 0 24 24" aria-hidden="true">
    <path d="M3 6h18M3 12h18M3 18h18"/>
  </svg>
</button>

<div class="app" id="app">

  <aside class="sidebar" id="sidebar" aria-label="Barra lateral">
    <div class="sb-brand" id="sbBrand"></div>

    <div class="sb-scroll">
      <div class="sb-profile">
        <div class="sb-profile-avatar" aria-hidden="true"><i class="fas fa-user"></i></div>
        <div class="sb-profile-info">
          <div class="sb-profile-name">{{ request.user.get_full_name|default:request.user.username }}</div>
          <div class="sb-profile-mail">{{ request.user.email|default:"Sin correo" }}</div>
        </div>
      </div>

      <section class="sb-section">
        <div class="sb-head"><i class="fas fa-user-graduate"></i><span>Gestión de estudiantes</span></div>
        <div class="sb-body">
          <a class="sb-link" href="{% url 'core:estudiantes_list' %}"><i class="fas fa-list-ul"></i><span>Registros</span></a>
        </div>
      </section>

      <section class="sb-section">
        <div class="sb-head"><i class="fas fa-layer-group"></i><span>Gestión de cursos</span></div>
        <div class="sb-body">
          <a class="sb-link" href="{% url 'core:cursos_list' %}"><i class="fas fa-table"></i><span>Registros de cursos</span></a>
          <a class="sb-link" href="{% url 'core:planificaciones_list' %}"><i class="fas fa-clipboard-check"></i><span>Planificaciones</span></a>
          <a class="sb-link" href="{% url 'core:sedes_list' %}"><i class="fas fa-map-marker-alt"></i><span>Sedes</span></a>
        </div>
      </section>

      {% if request.user.is_authenticated %}
        {% if request.user.tipo_usuario == 'ADMIN' or request.user.tipo_usuario == 'COORD' %}
          <section class="sb-section">
            <div class="sb-head"><i class="fas fa-newspaper"></i><span>Contenido</span></div>
            <div class="sb-body">
              <a class="sb-link" href="{% url 'core:noticias_list' %}"><i class="fas fa-newspaper"></i><span>Noticias (Portada)</span></a>
            </div>
          </section>
        {% endif %}
      {% endif %}

      <section class="sb-section">
        <div class="sb-head"><i class="fas fa-id-badge"></i><span>Gestión de usuarios</span></div>
        <div class="sb-body">
          <a class="sb-link" href="{% url 'usuarios:equipo_list' %}"><i class="fas fa-users-cog"></i><span>Equipo</span></a>
        </div>
      </section>

      <section class="sb-section">
        <div class="sb-head"><i class="fas fa-chart-bar"></i><span>Reportes</span></div>
        <div class="sb-body">
          <a class="sb-link" href="{% url 'core:reportes_home' %}"><i class="fas fa-file-alt"></i><span>Centro de reportes</span></a>
        </div>
      </section>

      <section class="sb-section">
        <div class="sb-head"><i class="fas fa-bullhorn"></i><span>Comunicados</span></div>
        <div class="sb-body">
          <a class="sb-link" href="{% url 'core:comunicados_list' %}"><i class="fas fa-envelope-open-text"></i><span>Ver comunicados</span></a>
        </div>
      </section>
    </div>

    <div class="sb-foot">
      <a class="sb-logout" href="{% url 'usuarios:logout' %}"><i class="fas fa-sign-out-alt"></i><span>Cerrar sesión</span></a>
      <div class="sb-meta">© {% now "Y" %}</div>
    </div>
  </aside>

  <main class="content">
    <nav class="topbar" id="topbar">
      <div class="ml-auto d-flex align-items-center">
        <img src="{% static 'img/logo/mi_logo.png' %}" class="topbar-logo" alt="Logo CPC">
      </div>
    </nav>

    <div class="container-page">
      {% block content %}{% endblock %}
    </div>

    <footer class="footer py-3">
      <div class="container text-center">
        <span>Desarrollado por <b>Campeones Para Coquimbo</b></span>
      </div>
    </footer>
  </main>
</div>

<script src="{% static 'vendor/jquery/jquery.min.js' %}"></script>
<script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

<script>
  (function(){
    var menuBtn  = document.getElementById('menuBtn');
    var topbar   = document.getElementById('topbar');
    var sidebar  = document.getElementById('sidebar');
    var sbBrand  = document.getElementById('sbBrand');

    if(sidebar) sidebar.classList.add('sb-elevated');

    function toggleSidebar(e){
      if(e) e.preventDefault();
      var open = document.body.classList.toggle('nav-open');
      if(menuBtn) menuBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
      if (open){
        if(menuBtn) menuBtn.classList.remove('is-hidden');
        if(sidebar) sidebar.classList.add('sb-elevated');
      }
    }
    if(menuBtn){ menuBtn.addEventListener('click', toggleSidebar); }

    var mq = window.matchMedia('(min-width: 992px)');
    function clean(){
      if(mq.matches){
        document.body.classList.remove('nav-open');
        if(menuBtn) menuBtn.setAttribute('aria-expanded','false');
      }
    }
    if(mq.addEventListener){ mq.addEventListener('change', clean); } else { mq.addListener(clean); }

    /* Móvil: ocultar hamburguesa al bajar, mostrar al subir */
    var lastY = window.pageYOffset || document.documentElement.scrollTop || 0;
    var threshold = 80;
    window.addEventListener('scroll', function(){
      if (!menuBtn) return;
      var y = window.pageYOffset || document.documentElement.scrollTop || 0;
      if (document.body.classList.contains('nav-open')) {
        menuBtn.classList.remove('is-hidden');
      } else {
        if (y > lastY && y > threshold){ menuBtn.classList.add('is-hidden'); }
        else { menuBtn.classList.remove('is-hidden'); }
      }
      lastY = y;
    }, { passive:true });

    /* Desktop: ocultar juntos topbar y franja superior del sidebar (sin efecto) */
    var lastDesktopY = window.pageYOffset || document.documentElement.scrollTop || 0;
    var deskThreshold = 40;
    window.addEventListener('scroll', function(){
      if(!topbar || !sbBrand) return;
      var y = window.pageYOffset || document.documentElement.scrollTop || 0;
      if (mq.matches){
        var scrollingDown = y > lastDesktopY;
        if (scrollingDown && y > deskThreshold){
          topbar.classList.add('topbar-hidden');
          sbBrand.classList.add('sb-top-hidden');
          if(sidebar) sidebar.classList.remove('sb-elevated');
        } else {
          topbar.classList.remove('topbar-hidden');
          sbBrand.classList.remove('sb-top-hidden');
          if(sidebar) sidebar.classList.add('sb-elevated');
        }
      } else {
        topbar.classList.remove('topbar-hidden');
        sbBrand.classList.remove('sb-top-hidden');
      }
      lastDesktopY = y;
    }, { passive:true });

    /* Móvil: sombra del sidebar suave al desplazarse */
    var lastY2 = window.pageYOffset || document.documentElement.scrollTop || 0;
    window.addEventListener('scroll', function(){
      if(!sidebar) return;
      var y = window.pageYOffset || document.documentElement.scrollTop || 0;
      var scrollingDown = y > lastY2;
      if (!mq.matches){
        if (scrollingDown && y > 10) sidebar.classList.remove('sb-elevated');
        else sidebar.classList.add('sb-elevated');
      }
      lastY2 = y;
    }, { passive:true });
  })();
</script>

<!-- Bloqueo de scroll en móvil al abrir menú -->
<script>
  (function(){
    var origScrollTop = 0;
    function lockScroll(){
      origScrollTop = window.pageYOffset || document.documentElement.scrollTop || 0;
      document.body.style.top = (-origScrollTop) + 'px';
      document.body.classList.add('scroll-locked');
    }
    function unlockScroll(){
      document.body.classList.remove('scroll-locked');
      document.body.style.top = '';
      window.scrollTo(0, origScrollTop);
    }
    var menuBtn = document.getElementById('menuBtn');
    if(menuBtn){
      var prevClick = menuBtn.onclick;
      menuBtn.onclick = function(e){
        if(prevClick) prevClick.call(this, e);
        var open = document.body.classList.contains('nav-open');
        if(open) lockScroll(); else unlockScroll();
      };
    }
    var mq = window.matchMedia('(min-width: 992px)');
    function onMQ(){
      if(mq.matches){
        unlockScroll();
        document.body.classList.remove('nav-open');
      }
    }
    if(mq.addEventListener){ mq.addEventListener('change', onMQ); } else { mq.addListener(onMQ); }
  })();
</script>

{% block extra_js %}{% endblock %}
</body>
</html>
