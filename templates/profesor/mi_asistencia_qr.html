{% extends "base.html" %}
{% block title %}Marcar mi asistencia (QR){% endblock %}
{% block header %}📷 Marcar mi asistencia (QR){% endblock %}

{% block content %}
<div class="card p-3" style="max-width:720px">
  {% if mensaje %}
    <div class="alert {% if ok %}success{% else %}error{% endif %}" style="margin-bottom:12px">
      {{ mensaje }}
    </div>
  {% endif %}

  <p class="muted" style="margin-top:0">
    Escanea el QR pegado en la entrada de la sede <b>o</b> usa tu ubicación si no hay QR disponible.
  </p>

  <form method="post" id="asistencia-form" class="row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    {% csrf_token %}
    <input type="hidden" name="action"  id="action-field" value="">
    <input type="hidden" name="qr_text" id="qr_text" value="">
    <input type="hidden" name="geo_lat" id="geo_lat">
    <input type="hidden" name="geo_lng" id="geo_lng">

    <button type="button" class="btn" id="scan-btn">📷 Escanear Código QR</button>
    <button type="button" class="btn" id="geo-in">📍 Marcar entrada (sin QR)</button>
    <button type="button" class="btn" id="geo-out">📍 Marcar salida (sin QR)</button>
  </form>

  <!-- IMPORTANTE: usar un DIV, no un <video> -->
  <div id="preview-container" style="display:none;margin-top:12px">
    <div id="qr-reader" style="width:100%;max-width:640px;border-radius:8px;border:1px solid #ccc;"></div>
    <p class="muted">Apunta la cámara al código QR de la sede.</p>
  </div>

  <hr>

  <div>
    <p style="margin:4px 0"><b>Última entrada:</b>
      {% if ultima_entrada %}
        {{ ultima_entrada.fecha|date:"d-m-Y" }} — {{ ultima_entrada.hora|time:"H:i" }} ({{ ultima_entrada.sede.nombre }})
      {% else %}—{% endif %}
    </p>
    <p style="margin:4px 0"><b>Última salida:</b>
      {% if ultima_salida %}
        {{ ultima_salida.fecha|date:"d-m-Y" }} — {{ ultima_salida.hora|time:"H:i" }} ({{ ultima_salida.sede.nombre }})
      {% else %}—{% endif %}
    </p>
  </div>

  <div class="mt-2">
    <a class="btn" href="{% url 'profesor:mi_historial_asistencia' %}">📊 Ver historial</a>
  </div>
</div>

<!-- QR -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script>
const form     = document.getElementById("asistencia-form");
const qrInput  = document.getElementById("qr_text");
const actInput = document.getElementById("action-field");

// === Escaneo QR ===
document.getElementById("scan-btn").addEventListener("click", async () => {
  const preview = document.getElementById("preview-container");
  preview.style.display = "block";

  const html5QrCode = new Html5Qrcode("qr-reader"); // <- id del DIV

  try {
    const devices = await Html5Qrcode.getCameras();
    if (!devices || !devices.length) {
      alert("No se detectó cámara.");
      preview.style.display = "none";
      return;
    }

    // Elegir cámara trasera si existe
    const backCam = devices.find(d => /back|rear|environment/i.test(d.label));
    const camId = backCam ? backCam.id : devices[0].id;

    await html5QrCode.start(
      camId,
      { fps: 10, qrbox: 250 },
      (qrMsg) => {
        // Al leer el QR, preguntamos acción y enviamos
        html5QrCode.stop();
        preview.style.display = "none";
        qrInput.value = qrMsg;         // ej. "SEDE:1"
        const esEntrada = confirm("¿Registrar ENTRADA?\n(Aceptar = Entrada, Cancelar = Salida)");
        actInput.value = esEntrada ? "entrada" : "salida";
        form.submit();
      },
      () => {}
    );
  } catch (err) {
    console.error(err);
    alert("No se pudo iniciar la cámara.");
    preview.style.display = "none";
  }
});

// === Geolocalización (sin QR) ===
function pedirGeoYEnviar(action){
  if (!navigator.geolocation) { alert("Tu navegador no soporta geolocalización."); return; }
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      document.getElementById("geo_lat").value = pos.coords.latitude;
      document.getElementById("geo_lng").value = pos.coords.longitude;
      actInput.value = action;
      qrInput.value  = ""; // aseguramos que no se use QR
      form.submit();
    },
    (err) => alert("No se pudo obtener la ubicación: " + err.message),
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}
document.getElementById("geo-in").addEventListener("click", () => pedirGeoYEnviar("entrada"));
document.getElementById("geo-out").addEventListener("click", () => pedirGeoYEnviar("salida"));
</script>
{% endblock %}
