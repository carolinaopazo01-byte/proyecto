{% extends "base/plantilla.html" %}
{% block title %}Marcar mi asistencia (UbicaciÃ³n){% endblock %}
{% block header %}ğŸ“ Marcar mi asistencia (UbicaciÃ³n){% endblock %}

{% block extra_css %}
<style>
  .card {
    border-radius: 14px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 2px 10px rgba(0,0,0,.05);
    margin: 0 auto;
  }
  .muted {
    color: #64748b;
    font-size: .9rem;
  }
  .form-select-sm, .form-control-sm {
    border-radius: .45rem;
    font-size: .88rem;
  }
  .btn {
    border-radius: .45rem;
    font-weight: 700;
    min-width: 160px;
  }
  .btn-primary, .btn-success, .btn-info {
    color: #fff;
  }
  .btn {
    background-color: #0e7c86;
    border-color: #0e7c86;
    color: #fff;
  }
  .btn:hover {
    background-color: #0a5a64;
    border-color: #0a5a64;
  }
  .btn-outline-secondary {
    background-color: #fff;
    border-color: #e5e7eb;
    color: #374151;
  }
  .btn-outline-secondary:hover {
    background-color: #f3f4f6;
  }
  hr {
    margin: 1.25rem 0;
    border-top: 1px solid #e5e7eb;
  }
  .alert {
    border-radius: .75rem;
    font-size: .9rem;
  }
  .text-muted.small {
    font-size: .85rem;
  }
  /* Ajuste responsive */
  @media (max-width: 576px) {
    .card { padding: 1rem; }
    .btn { width: 100%; }
    .d-flex { flex-direction: column !important; align-items: stretch !important; }
  }
</style>
{% endblock %}

{% block content %}
<div class="card p-3" style="max-width:720px">
  {% if mensaje %}
    <div class="alert {% if ok %}alert-success{% else %}alert-danger{% endif %} mb-3" role="alert">
      {{ mensaje }}
    </div>
  {% endif %}

  <p class="muted mb-3">
    Usa tu <b>ubicaciÃ³n</b> para registrar tu <b>entrada</b> o <b>salida</b> en la sede mÃ¡s cercana.
  </p>

  {% if mis_cursos %}
    <div class="mb-3 d-flex align-items-center gap-2 flex-wrap">
      <label class="form-label mb-0 small">Selecciona curso</label>
      <select id="cursoSelect" class="form-select form-select-sm" style="max-width:420px">
        {% for c in mis_cursos %}
          <option value="{{ c.id }}" {% if curso_sel and c.id == curso_sel.id %}selected{% endif %}>
            {{ c.nombre }} â€” {{ c.sede.nombre|default:"(sin sede)" }}
          </option>
        {% endfor %}
      </select>
    </div>
  {% else %}
    <div class="mb-2 text-muted small">No tienes cursos asignados.</div>
  {% endif %}

  <div class="mb-3" style="font-size:14px">
    <b>Curso:</b> <span id="cursoNombre">{{ curso_sel.nombre|default:"â€”" }}</span>
    &nbsp;Â·&nbsp;
    <b>Sede:</b> <span id="sedeNombre">
      {% if curso_sel and curso_sel.sede %}{{ curso_sel.sede.nombre }}{% else %}â€”{% endif %}
    </span>
  </div>

  <form method="post" id="asistencia-form" class="d-flex flex-wrap gap-2 align-items-center">
    {% csrf_token %}
    <input type="hidden" name="action"  id="action-field" value="">
    <input type="hidden" name="geo_lat" id="geo_lat">
    <input type="hidden" name="geo_lng" id="geo_lng">
    <input type="hidden" name="geo_acc" id="geo_acc">
    <input type="hidden" name="curso" id="curso-hidden" value="{{ curso_sel.id|default:'' }}">

    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
      <label class="form-label mb-0 small">Radio (prueba, m)</label>
      <input type="number" name="radio_test" id="radio_test"
             class="form-control form-control-sm" style="max-width:140px"
             min="50" max="2000" placeholder="ej. 400"
             value="{{ radio_test|default_if_none:'' }}">
      <span class="text-muted small">Deja vacÃ­o para usar el radio real de la sede.</span>
    </div>

    <div class="w-100"></div>

    <button type="button" class="btn" id="geo-in">ğŸ“ Marcar entrada</button>
    <button type="button" class="btn btn-outline-secondary" id="geo-out">ğŸ“ Marcar salida</button>
  </form>

  <hr>

  <div class="mb-2">
    <p class="mb-1"><b>Ãšltima entrada:</b>
      {% if ultima_entrada %}
        {{ ultima_entrada.fecha|date:"d-m-Y" }} â€” {{ ultima_entrada.hora|time:"H:i" }} ({{ ultima_entrada.sede.nombre }})
      {% else %}â€”{% endif %}
    </p>
    <p class="mb-0"><b>Ãšltima salida:</b>
      {% if ultima_salida %}
        {{ ultima_salida.fecha|date:"d-m-Y" }} â€” {{ ultima_salida.hora|time:"H:i" }} ({{ ultima_salida.sede.nombre }})
      {% else %}â€”{% endif %}
    </p>
  </div>

  <div class="mt-3 text-end">
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'profesor:mi_historial_asistencia' %}">
      ğŸ“Š Ver historial
    </a>
  </div>
</div>

<script>
  (function(){
    var sel = document.getElementById('cursoSelect');
    var spanCurso = document.getElementById('cursoNombre');
    var spanSede  = document.getElementById('sedeNombre');
    var hidCurso  = document.getElementById('curso-hidden');

    if(sel){
      sel.addEventListener('change', function(){
        var opt = sel.options[sel.selectedIndex];
        var txt = opt ? opt.text : "";
        var partes = txt.split("â€”");
        spanCurso.textContent = (partes[0] || "").trim() || "â€”";
        spanSede.textContent  = (partes[1] || "").trim() || "â€”";
        if (hidCurso) hidCurso.value = sel.value || "";
      });
    }
  })();

  (function(){
    var form = document.getElementById('asistencia-form');
    var act  = document.getElementById('action-field');
    var sel  = document.getElementById('cursoSelect');
    var hidCurso = document.getElementById('curso-hidden');

    function pedirGeoYEnviar(action){
      if(!navigator.geolocation){ alert("Tu navegador no soporta geolocalizaciÃ³n."); return; }
      navigator.geolocation.getCurrentPosition(function(pos){
        document.getElementById('geo_lat').value = pos.coords.latitude;
        document.getElementById('geo_lng').value = pos.coords.longitude;
        document.getElementById('geo_acc').value = Math.round(pos.coords.accuracy || 0);
        if (sel && sel.value) hidCurso.value = sel.value;
        act.value = action;
        form.submit();
      }, function(err){
        alert("No se pudo obtener la ubicaciÃ³n: " + err.message);
      }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    }

    document.getElementById('geo-in')?.addEventListener('click', ()=> pedirGeoYEnviar('entrada'));
    document.getElementById('geo-out')?.addEventListener('click', ()=> pedirGeoYEnviar('salida'));
  })();
</script>
{% endblock %}
