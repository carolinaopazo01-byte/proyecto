{% extends "base/plantilla.html" %}
{% block title %}Asistencia{% endblock %}
{% block header %}ðŸ“‹ Listado de asistencia por curso{% endblock %}

{% block extra_css %}
<style>
  .cpc-safe{ max-width:1080px; margin:0 auto; }
  .card{ border-radius:14px; border:1px solid #e5e7eb; overflow:hidden; }
  .card-body{ padding:1.25rem 1.4rem; }
  .card-title{ font-weight:800; color:#0f172a; }
  .text-muted{ color:#64748b !important; font-size:.9rem; }

  .table{ border-collapse:collapse; width:100%; }
  .table thead{ background:#f1f5f9; }
  .table thead th{ font-size:.82rem; color:#334155; font-weight:700; text-transform:uppercase; border-bottom:2px solid #e2e8f0; }
  .table td,.table th{ vertical-align:middle; padding:.55rem .75rem; }
  .table-striped tbody tr:nth-child(even){ background-color:#f9fafb; }

  .badge{ font-size:.78rem; font-weight:700; padding:.4em .55em; border-radius:.5rem; }
  .badge.bg-success{background:#dcfce7;color:#166534;}
  .badge.bg-danger{background:#fee2e2;color:#991b1b;}
  .badge.bg-warning{background:#fef9c3;color:#854d0e;}
  .badge.bg-secondary{background:#e5e7eb;color:#374151;}

  .btn{ border-radius:.45rem; font-weight:700; }
  .btn-sm{ padding:.35rem .7rem; font-size:.85rem; }
  .btn-outline-secondary:hover{ background:#f3f4f6; }
  .btn-primary{ background:#0e7c86; border-color:#0e7c86; }
  .btn-primary:hover{ background:#0a5a64; border-color:#0a5a64; }

  @media (max-width:768px){
    .table{ font-size:.82rem; }
    .table thead{ display:none; }
    .table tr{ display:block; margin-bottom:.75rem; border:1px solid #e5e7eb; border-radius:.75rem; overflow:hidden; background:#fff; }
    .table td{ display:flex; justify-content:space-between; padding:.55rem .9rem; border:none; border-bottom:1px solid #f1f5f9; }
    .table td:last-child{ border-bottom:none; }
    .table td::before{ content:attr(data-label); font-weight:700; color:#475569; text-transform:capitalize; }
  }
</style>
{% endblock %}

{% block content %}
<p class="mb-3">A continuaciÃ³n se muestran tus cursos con los alumnos inscritos y su Ãºltimo estado de asistencia registrado.</p>

<div class="cpc-safe">
  {% if cursos %}
    {% for c in cursos %}
      <div class="card mb-4 shadow-sm">
        <div class="card-body">

          <!-- Encabezado con tÃ­tulo a la izquierda y acciones arriba a la derecha -->
          <div class="d-flex flex-column flex-sm-row align-items-sm-start justify-content-sm-between gap-2 mb-2">
            <div>
              <h5 class="card-title mb-1">{{ c.nombre }}</h5>
              <p class="text-muted mb-0">
                {{ c.sede.nombre }} Â· {{ c.disciplina.nombre }}<br>
                Programa: {{ c.get_programa_display }} â€” Cupos: {{ c.cupos }}
              </p>
            </div>
            <div class="text-sm-end">
              <a class="btn btn-outline-secondary btn-sm me-2" href="{% url 'profesor:asistencia_historial' c.id %}">
                <i class="fas fa-clock me-1"></i> Historial
              </a>
              <a class="btn btn-primary btn-sm" href="{% url 'core:asistencia_tomar' c.id %}">
                <i class="fas fa-clipboard-check me-1"></i> Tomar asistencia
              </a>
            </div>
          </div>

          {% if c.ultima %}
            <p class="mb-2">
              <strong>Ãšltima asistencia:</strong>
              {{ c.ultima.fecha|date:"d/m/Y" }} Â·
              {% if c.ultima.estado == "PEND" %}
                <span class="badge bg-warning">Pendiente</span>
              {% elif c.ultima.estado == "ENCU" %}
                <span class="badge bg-primary">En curso</span>
              {% elif c.ultima.estado == "CERR" %}
                <span class="badge bg-success">Cerrada</span>
              {% else %}
                <span class="badge bg-secondary">â€”</span>
              {% endif %}
            </p>

            {% if c.ultima_detalles %}
              <div class="table-responsive mt-3">
                <table class="table table-striped table-sm align-middle mb-0">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Nombre</th>
                      <th>RUT</th>
                      <th>Estado asistencia</th>
                      <th>Observaciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for d in c.ultima_detalles %}
                      <tr>
                        <td data-label="#">{{ forloop.counter }}</td>
                        <td data-label="Nombre">{{ d.estudiante.nombres }} {{ d.estudiante.apellidos }}</td>
                        <td data-label="RUT">{{ d.estudiante.rut }}</td>
                        <td data-label="Estado asistencia">
                          {% if d.estado == "P" %}
                            <span class="badge bg-success">Presente</span>
                          {% elif d.estado == "A" %}
                            <span class="badge bg-danger">Ausente</span>
                          {% elif d.estado == "J" %}
                            <span class="badge bg-warning text-dark">Justificado</span>
                          {% else %}
                            <span class="badge bg-secondary">Sin registro</span>
                          {% endif %}
                        </td>
                        <td data-label="Observaciones">{{ d.observaciones|default:"â€”" }}</td>
                      </tr>
                    {% empty %}
                      <tr><td colspan="5" class="text-center text-muted py-2">No hay registros de asistencia aÃºn.</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="text-muted mb-0">No hay detalles cargados para la Ãºltima asistencia.</p>
            {% endif %}
          {% else %}
            <p class="text-muted mb-0">No hay asistencias registradas todavÃ­a.</p>
          {% endif %}

        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-light border text-center">No tienes cursos asignados actualmente.</div>
  {% endif %}
</div>
{% endblock %}
